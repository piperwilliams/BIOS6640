---
title: "BIOS 6640-R Project"
author: "Piper Williams"
date: "10/26/2018"
output: pdf_document
header-includes:
   - \usepackage{indentfirst}
indent: true
fontsize: 12pt
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# load libraries
library(dplyr)
library(tibble)
library(ggplot2)
library(gridExtra)
library(tseries) # for ccf() function
library(RColorBrewer)
library(sp)
library(maptools) 
library(knitr)
library(kableExtra)

# read in data set
data <- read.csv("/Users/piper/Piper Documents/R and Python/Project 1/DataRaw/MozSyntheticMalaria.csv")

# create variable "malaria incidence in cases per 1,000 in children under 5"
data <- mutate(data,
               cptu5 = (malaria / (Population_UN*u5weight))*1000)

# exclude data from 2017
data <- data %>% 
  filter(!(Epiyear == 2017))

```


###Background

Malaria is a parasitic blood disease that is most commonly transmitted via the *Anopheles* mosquito species.$^1$ Other forms of malaria parasite transmission include congenital transmission and transfusion transmission.$^1$ There are four malaria parasites known to infect humans: *Plasomdium falciparum, vivax, ovale,* and *malariae*.$^1$ Symptoms associated with malaria begin to manifest anywhere from seven to thirty days after the initial exposure and include fever, headache, increased heart rate, and various gastrointestinal problems.$1$ If an infected individual is not diagnosed and treated promptly, malaria has the potential to be fatal. It should be noted that the most vulnerable population to malaria infection is children under five years of age, as this population is less likley to have acquired immunity. While the global incidence of malaria has decreased by approximately 18% from 2010 to 2016, malaria remains a major public health issue for numerous countries.$^2$     


In the year 2016, there were approximately 216 million reported cases of malaria  and 450,000 malaria-related deaths worldwide.$^3$ In the same year, 91% of all malaria-related deaths were concentrated in the World Health Organization (WHO) African region, which includes the country of Mozambique.$^3$ In Mozambique, approximately four to six million malaria cases are reported each year. While this disease is known to be largely preventable and curable, it continues to be an epidemic in Mozambique and other countries in sub-Saharan Africa.$^4$ Allotting preventative resources to highly vunerable areas, which include insecticide-treated bednets and indoor residual spraying, educating citizens in these regions about the importance of using these resources, and malaria surveillance are each critical components of malaria prevention and possible elimination.$^5$ To ensure that malaria prevention resources are distributed and implemented effectively, the trends in malaria incidence must be better understood. 


In this report, the spatial and temporal trends in malaria incidence in children under five and their relationship to specific climatic conditions in Mozambique were further explored. Increased rainfall and increased ambient temperatures have previously been shown to be associated with increased malaria transmission, as these climate conditions provide an optimal environment for the malaria parasite to be transmitted to the *Anopheles* mosquito and, ultimately, to humans.$^1$ However, the time at which these climatic conditions are associated with malaria exposure remains unknown. Increased rainfall creates a larger number of collections of water, which serve as prime breeding sites for the mosquito species.$^1$ Increased ambient temperatures shortens the malaria parasite's growth cycle, which increases the probability of transmission from an infected mosquito mother to her offspring. In uncovering these spatio-temporal relationships and their association with climatic trends, there is an increased potential to prevent malaria transmission in Mozambique and other countries around the world. $\vspace{0.25cm}$


###Description of Research Problem and Data


The ultiamte goal of this report was to uncover underlying trends in malaria incidence in Mozambique. In particular, the visuals presented aimed to shed light on geographic and seasonal trends in malaria incidence over time and their association with trends in certain climatic conditions as well. As discussed previously, increased rainfall and temperature are strongly associated with increased malaria transmission. However, the lag times of rainfall and temperature that are most associated with malaria incidence are not currently known. The relationships between these two climatic conditions and malaria incidence were extensively explored here. In better understanding these trends and their associations with one another, preventative resources could be allocated more effectively to vulnerable areas in Mozambique and potentially decrease malaria transmission.


The final data set used in subsequent visualizations consisted of weekly data for the 142 districts of Mozambique from 2010 to 2017. Data was collected for the first 9 weeks of 2017. Due to the lack of data for this year, I chose to exclude 2017 data in this report. Variables measured included weekly total rainfall (mm), average rainfall (mm), average temperature (Celcius), relative humidity (%), saturation vapor pressure deficit (mmHg), surface barometric pressure (hPa), total district population, proportion of total population under five years of age, number of malaria cases under five reported, etc. The outcome-of-interest was cases per 1000 in children under five, which was calculated as follows:


$$
CPT-U5 = [\frac{C-U5}{(Population_{total}*U5_{weight})}]*1000
$$


$CPT-U5$ is cases per 1000 under 5, $C-U5$ is total number of cases under 5, $Population_{total}$ is the total population of the district, and $U5_{weight}$ is the proportion of the total population under five years of age. A proportion of cases was used as the outcome rather than simply the number of malaria cases in children under five to control against the fact that certain districts have a larger total population than others (thus, more malaria cases simply due to a larger population in that district).  


###Results
####*Initially-Observed Data Trends*


While there was no formal statistical modeling conducted in this report, exploratory data analyses were carried out to better visualize the outcome-of-interest (cases per 1000 under 5, CPT-U5) and its relationship with other variables-of-interest. First, it was discovered that CPT-U5 was postively skewed (see Appendix). A log-transformation as well as square-root transformation of the outcome were implemented to see if this would change the overall distribution of the outcome. A square-root transformed outcome seemed to follow a relatively normal distribution (see Appendix).


The relationships between CPT-U5 and weekly total rainfall (mm) as well as average temperature (Celcius) are visualized below. These trends were also evaluated separately for each of the four regions in Mozambique.$\vspace{0.5mm}$ 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=8}
g1 <- ggplot(data=data, aes(color=Region)) +
  geom_point(aes(x=rainTot, y=cptu5)) +
  geom_smooth(aes(x=rainTot, y=cptu5)) +
  labs(x="Weekly Total Rainfall", y="Cases per 1000 Under 5") +
  scale_color_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))
g2 <- ggplot(data=data, aes(color=Region)) +
  geom_smooth(aes(x=rainTot, y=cptu5)) +
  labs(x="Weekly Total Rainfall", y="Cases per 1000 Under 5") +
  scale_color_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))
grid.arrange(g1, g2, nrow = 1)

```


From a first glance, the smoothing splines above show that there is a non-linear relationship between rainfall and CPT-U5. The graphs also indicate that, overall, the northern region of Mozambique tended to have a higher proportion of CPT-U5, while the southern region tended to have a lower porportion of CPT-U5. While there appears to be a somewhat quadratic trend between CPT-U5 and rainfall, it is important to note that this could be due to the fact that the right tails of the smoothing splines are heavily influenced by the small number of extremely large rainfall data points. It is well known that cubic smoothing splines can be heavily influenced by "outliers"/extreme observations in the data, and one should be cautious when interpretting smoothing splines if extreme data values are present.$\vspace{0.5cm}$ 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=8}
g3 <- ggplot(data=data, aes(color=Region)) +
  geom_point(aes(x=tavg, y=cptu5)) +
  geom_smooth(aes(x=tavg, y=cptu5)) +
  labs(x="Average Weekly Temperature", y="Cases per 1000 Under 5") +
  scale_color_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))
g4 <- ggplot(data=data, aes(color=Region)) +
  geom_smooth(aes(x=tavg, y=cptu5)) +
  labs(x="Average Weekly Temperature", y="Incidence in Cases per 1000 Under 5")+
  scale_color_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))
grid.arrange(g3, g4, nrow = 1)

```


The plots above indicate a potential quadratic, maybe even quartic relationship between average temperature and CPT-U5. Similarly to the previous graphs, this indicates that, overall, the nothern region tends to have a higher proportion of CPT-U5, while the southern region tends to have a lower proportion of CPT-U5. Also, these plots show that there is a "sweet spot" for malaria incidence in terms of temperature. As discussed previously, it is true that malaria transmission tends to increase with an increase in temperature, but this is only up to a certain point. One can imagine that as temperature continues to increase, there may be a threshold at which malaria parasites cannot survive. Thus, this explains why we see a drop-off in the incidence of malaria beyond a certain temperature.   


####*Optimal Lag of Total Rainfall and Average Temperature*


It is known that there is a strong association between malaria incidence and climatic conditions, such as rainfall and temperature. However, the optimal lag time between these climatic conditions and malaria incidence is not currently well known. The cross-correlation function is helpful in determining which lags of the climatic conditions may be useful predictors of CPT-U5. It is important to note that a negative lag indicates that there is a correlation between the climatic condition at a time prior to *t* and malaria incidence at time *t*. A positive lag indicates that there is a correlation between the climatic condition at a time after *t* and malaria incidence at time *t*. Below are the cross-correlation function plots for weekly total rainfall and weekly average temperature. Also included below is a table that summizes the lag assocated with the largest auto-correlation function ($|ACF|$) value. $\vspace{0.5cm}$ 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=3, fig.width=8}
# ccf plots to determine optimal lead length
par(mfrow = c(1,2))
rain.ccf <- ccf(data$rainTot, data$cptu5, main = "CCF Plot: Rainfall") # optimal lead ~ 4
temp.ccf <- ccf(data$tavg, data$cptu5, main = "CCF Plot: Temperature") # optimal lead ~ 15
# numerical estimates of max ACF and corresponding lag/lead
max.acf1 <- max(rain.ccf$acf) # 0.1197 = max ACF
rain.lag <- rain.ccf$lag[which(rain.ccf$acf > max.acf1-0.0001 & rain.ccf$acf < max.acf1+0.0001)] # -4

max.acf2 <- max(temp.ccf$acf) # 0.2101 = max ACF
temp.lag <- temp.ccf$lag[which(temp.ccf$acf > max.acf2-0.0001 & temp.ccf$acf < max.acf2+0.0001)] # -16
 # I realize that one limitation of this method is the default
 # utilizes Pearson correlation


# create a table summarizing these results
rain.ccf.results <- c(rain.lag, round(max.acf1, 4))
temp.ccf.results <- c(temp.lag, round(max.acf2, 4))
labels <- c('Weekly Total Rainfall', 'Average Weekly Temperature')
ccf.results <- rbind(rain.ccf.results, temp.ccf.results)
ccf.results <- as.data.frame(cbind(labels, ccf.results))
rownames(ccf.results) <- NULL
colnames(ccf.results) <- c("", "Lag", "Max. ACF")

knitr::kable(ccf.results, format = "latex", booktabs = TRUE,
              align=rep('c')) %>%
   kable_styling(position = "center") %>%
   column_spec(1, width = "14em") %>%
   column_spec(2, width = "5em") %>%
   column_spec(3, width = "6em")

```


Here, we can see that the optimal lags for total rainfall and temperature were -4 and -16, respectively. This means that rainfall 4 weeks prior to *t* is most strongly correlated with CPT-U5 at *t* and average temperature 16 weeks prior to *t* is most strongly correlated with CPT-U5 at *t*. It was originally thought that rainfall and temperature lag times typically ranged from 2 to 8 weeks. While the results from the CCF Rainfall plot are consistent with this range of expected lag times, the CCF Temperature plot indicates that the lag time for temperature was much longer than originally anticipated. One key point that should be made is that the ACF values for lags proximal to the -16 lag seemed to be extremely close in value to the ACF at lag -16. So while the -16 lag had the highest $|ACF|$, this was only marginally so. Another key point that should be made is that the cross-correlation function uses the Pearson correlation method in its calculation of the ACF. It is possible that the correlation between the climatic condition variables and the outcome-of-interest are not linearly correlated. This may be why we see a difference in the actual optimal lag time for temperature here versus the anticipated lag time.    


####*Quarterly Malaria Incidence Across Mozambique Regions and Provinces*


Rather than aggregating over all time, the graphs below show malaria incidence in CPT-U5 for each annual quarter. Visualizing the data as such will give a better sense of the dynamic trend in malaria incidence over time. Also, in breaking up data visualizations into annual quarters, the temporal trends in the climatic conditions and their relationship with malaria incidence over time will hopefully become more apparent as well. For the graphs below and for the remaining data visualizations, the data will be broken up via annual quarters. Quarter 1 was defined as weeks 1-13, quarter 2 as weeks 14-26, quarter 3 as weeks 27-39, and quarter 4 as weeks 40+. For the year 2015, there were 53 weeks of data recorded, and for the purposes of this report, week 53 was chosen to be included in quarter 4. The bar graphs below show the average CPT-U5 across regions (bar graph 1) and the average CPT-U5 across provinces (bar graph 2).$\vspace{0.5cm}$ 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=5, fig.width=8, dpi=125}
# make Maputo one province
data$Province <- as.character(data$Province)
data$Province[data$Province %in% c("MAPUTO", "MAPUTO CIDADE")] <- "MAPUTO"

# check that levels were combined correctly
data$Province <- as.factor(data$Province)
# levels(data$Province)

# region with most cases/1000 under 5 (aggregated over all time)
avg.cptu5.by.region <- data %>%
  group_by(Region) %>%
  summarise(mean.cptu5 = mean(cptu5)) # Northern region = highest mean cptu5

mal.by.region <- data %>%
  group_by(Region) %>%
  summarise(mean.malaria = mean(malaria)) # Northern region = highest mean malaria cases u5

# see if certain parts of year have higher incidence compared to others
data <- data %>%
  mutate(Quarter = cut(Epiweek, breaks = c(0, 13, 26, 39, Inf),
         labels = c("Quarter 1" , "Quarter 2", "Quarter 3", "Quarter 4")))

avg.quarter.cptu5.by.region <- data %>%
  group_by(Region, Quarter) %>%
  summarise(mean.cptu5 = mean(cptu5)) # q1 and q2 seem to have higher incidence

avg.quarter.cptu5.by.province <- data %>%
  group_by(Province, Quarter) %>%
  summarise(mean.cptu5 = mean(cptu5))

# plot this data
ggplot(data=avg.quarter.cptu5.by.region) +
  geom_bar(stat='identity', aes(x=Quarter, y=mean.cptu5, fill=Region)) +
  facet_wrap( ~Region, ncol = 2) +
  labs(y="Cases per 1000 Under 5", x="Annual Quarter",
       title = "Malaria Incidence by Quarter Across Regions") +
  scale_fill_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))

```


The graphs show that, on average, the northern region had the highest average CPT-U5 (average CPT-U5: 15.57) while the southern region had the lowest average CPT-U5 (average CPT-U5: 5.87). Across all four regions, annual quarters 1 and 2 seemed to have a higher average CPT-U5 in comparison to quarters 3 and 4. $\vspace{0.5cm}$ 


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=6, fig.width=8, dpi=125}
ggplot(data=avg.quarter.cptu5.by.province) +
  geom_bar(stat='identity', aes(x=Quarter, y=mean.cptu5, fill=Province)) +
  facet_wrap( ~Province, ncol = 2) +
  labs(y="Cases per 1000 Under 5", x="Annual Quarter",
       title = "Malaria Incidence by Quarter Across Provinces") +
  scale_fill_manual(values = c("purple4", "purple1", "darkblue",
                               "blue", "deepskyblue3", "cyan2", "yellow1",
                               "orange1", "deeppink1", "deeppink4"))

```


Bar graph 2 was stratified by provinces in Mozambique rather than regions to get a better sense of which provinces are contributing more to the regional patterns observed in the previous graph. Here, we can see that the Niassa province had the highest recorded average CPT-U5 and the Maputo province the lowest recorded average CPT-U5. The Niassa province is located in the northern region of Mozambique, while the Maputo province is located in the southern region of Mozambique. Again, annual quarters 1 and 2 seemed to have a higher average CPT-U5 in comparison to quarters 3 and 4 at the provincial level, similarly to what was observed at the regional level. 


Two observations become exceedingly obvious just from the bar graphs alone. First, malaria incidence is geogrpahically dynamic. Second, malaria incidence is temporally dynamic. 


####*Quarterly Total Rainfall and Temperature Across Mozambique Provinces*


Now that the optimal lag times for total rainfall and temperature have been determined, it would be beneficial to understand the regional and temporal differences in total rainfall and temperature across Mozambique. Below are provincial maps of Mozambique that show average total rainfall and average temperature by annual quarters.$\vspace{0.5cm}$   


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# average rain total and tavg for each province
rain.province <- as.data.frame(tapply(data$rainTot, list(data$Province), mean))
colnames(rain.province) <- c("avg.rainTot")
tavg.province <- as.data.frame(tapply(data$tavg, list(data$Province), mean))
colnames(tavg.province) <- c("avg.tavg")
all.stats.province <- cbind(rain.province, tavg.province)

# average rain total and tavg for each district
rain.district <- as.data.frame(tapply(data$rainTot, list(data$DISTCODE), mean))
colnames(rain.district) <- c("avg.rainTot")
tavg.district <- as.data.frame(tapply(data$tavg, list(data$DISTCODE), mean))
colnames(tavg.district) <- c("avg.tavg")
all.stats.district <- cbind(rain.district, tavg.district)

# import shape file for provinces
poly.province <- readShapePoly("/Users/piper/Piper Documents/R and Python/Project 1/DataRaw/mozambique_admin1.shp")
# plot(poly.province)

# import shape file for districts
poly.district <- readShapePoly("/Users/piper/Piper Documents/R and Python/Project 1/DataRaw/Moz_admin2.shp")
# plot(poly.district)

# rename rows to match shape files
rownames(all.stats.province) <- poly.province$admin_1
rownames(all.stats.district) <- poly.district$DISTCODE

# combine 'all.stats' data frame with the shape file
polydata.province <- SpatialPolygonsDataFrame(poly.province, all.stats.province, match.ID = FALSE)
polydata.district <- SpatialPolygonsDataFrame(poly.district, all.stats.district, match.ID = FALSE)

########################### ANNUAL QUARTER PLOTS #################################
data <- data %>%
  mutate(Quarter = cut(Epiweek, breaks = c(0, 13, 26, 39, Inf),
                       labels = c("Quarter 1" , "Quarter 2",
                                  "Quarter 3", "Quarter 4")))

# average rain total and tavg for each province per quarter
rain.province2 <- as.data.frame(tapply(data$rainTot,
                                       list(data$Province, data$Quarter), mean))
tavg.province2 <- as.data.frame(tapply(data$tavg,
                                       list(data$Province, data$Quarter), mean))
all.stats.province2 <- cbind(rain.province2, tavg.province2)
colnames(all.stats.province2) <- c('rain.Quarter1', 'rain.Quarter2',
                                   'rain.Quarter3','rain.Quarter4',
                                   'tavg.Quarter1', 'tavg.Quarter2',
                                   'tavg.Quarter3', 'tavg.Quarter4')

# average rain total and tavg for each district per quarter
rain.district2 <- as.data.frame(tapply(data$rainTot,
                                       list(data$DISTCODE, data$Quarter), mean))
tavg.district2 <- as.data.frame(tapply(data$tavg,
                                       list(data$DISTCODE, data$Quarter), mean))
all.stats.district2 <- cbind(rain.district2, tavg.district2)
colnames(all.stats.district2) <- c('rain.Quarter1', 'rain.Quarter2',
                                   'rain.Quarter3', 'rain.Quarter4',
                                   'tavg.Quarter1', 'tavg.Quarter2',
                                   'tavg.Quarter3', 'tavg.Quarter4')

# rename rows to match shape files
rownames(all.stats.province2) <- poly.province$admin_1
rownames(all.stats.district2) <- poly.district$DISTCODE

# combine 'all.stats' data frame with the shape file
polydata.province2 <- SpatialPolygonsDataFrame(poly.province, all.stats.province2, match.ID = F)
polydata.district2 <- SpatialPolygonsDataFrame(poly.district, all.stats.district2, match.ID = F)

#plot avg. total rainfall for each province aggregated over annual quarters
spplot(polydata.province2, c('rain.Quarter1', 'rain.Quarter2',
                             'rain.Quarter3','rain.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Average Total Weekly Rainfall (mm)",
       as.table = TRUE, col="transparent")

```


There are a number of conclusions we can draw from these map visualizations. First, rainfall seemed to be higher for quarters 1 and 4 (highest for quarter 1). This is consistent with the lag time for rainfall that is most associated with malaria incidence. The optimal lag time for rainfall was found to be 4 weeks prior to malaria incidence. Thus, it makes sense that the highest total rainfall occurs in quarter 1. We previously saw that quarters 1 and 2 have a higher proportion of cases per 1000 under 5. Thus, it is expected that rainfall would be highest during quarter 1. Also, there seems to be almost zero rainfall on average in quarter 3. These maps indicate that rainfall varies across provinces and also varies across annual quarters. 


Next, during quarter 1, the northern region had the largest average total weekly rainfall compared to the other regions In fact, the Niassa province, which is in the northern region, experienced approximately 23.94 mm of weekly total rainfall, on average. The province that experiences the second largest weekly total rainfall during this quarter was Cabo Delgado, another province in the northern region, with an average weekly total rainfall of 19.58 mm. 


There is one interesting pattern that should be discussed. It might have been expected that the northern region/provinces would have higher rainfall year-round due to the fact that this area has a higher level of malaria transmission compared to other regions/provinces. However, in quarters 2-4, it is clear that this is not the case. For example, in quarter 4, it seems that the central region, even some portion of the southern region, experiences more rainfall in comparison to the northern region. This indicates that the northern region may experience more inconsistent and extreme climatic patterns in comparison to the other regions.$\vspace{0.5cm}$


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# plot avg. temperature for each province aggregated over annual quarters
spplot(polydata.province2, c('tavg.Quarter1', 'tavg.Quarter2',
                             'tavg.Quarter3','tavg.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Average Temperature (Celcius)",
       as.table = TRUE, col="transparent")

```


The plots above show average temperature across provinces per annual quarter. It appears that quarter 4 had the highest average temperature compared to quarters 1-3. This is consistent with the lag time of temperature that is most associated with malaria incidence, which was found to be 16 weeks prior to malaria incidence. We would expect the highest temperatures to be in quarter 4 based on this information, and this seemed to be the case. Quarter 1 seemed to have the second highest average temperature across provinces. 


Unlike rainfall, the northern region/provinces generally seemed to have higher temperature year-round in comparison to the other regions/provinces. In particular, the two provinces that seemed to have the highest average temperatures year round were Nampula and Cabo Delgado. It is also worth noting that the temperature across all provinces and across all quarters only varies by about 8 degrees Celcius. 


####*Quarterly Malaria Incidence Across Mozambique Provinces*

Now we want to understand if malaria incidence is clustered in a particular region/province in Mozambique. As shown previously, we would expect the northern region to have a higher malaria incidence compared to the other regions/provinces.$\vspace{0.5cm}$  

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# avg. cptu5 for each province
cptu5.province <- as.data.frame(tapply(data$cptu5, list(data$Province), mean))
colnames(cptu5.province) <- c("avg.cptu5")

# avg. cptu5 for each district
cptu5.district <- as.data.frame(tapply(data$cptu5, list(data$DISTCODE), mean))
colnames(cptu5.district) <- c("avg.cptu5")

# rename rows to match shape files
rownames(cptu5.province) <- poly.province$admin_1
rownames(cptu5.district) <- poly.district$DISTCODE

# combine data frame with the shape file
polydata.cptu5.province <- SpatialPolygonsDataFrame(poly.province, cptu5.province, match.ID = F)
polydata.cptu5.district <- SpatialPolygonsDataFrame(poly.district, cptu5.district, match.ID = F)

######################### ANNUAL QUARTER PLOTS ################################
# average cptu5 for each province per quarter
cptu5.province2 <- as.data.frame(tapply(data$cptu5,
                                        list(data$Province, data$Quarter), mean))
colnames(cptu5.province2) <- c('cptu5.Quarter1', 'cptu5.Quarter2',
                                   'cptu5.Quarter3', 'cptu5.Quarter4')

# average cptu5 for each district per quarter
cptu5.district2 <- as.data.frame(tapply(data$cptu5,
                                        list(data$DISTCODE, data$Quarter), mean))
colnames(cptu5.district2) <- c('cptu5.Quarter1', 'cptu5.Quarter2',
                               'cptu5.Quarter3', 'cptu5.Quarter4')

# rename rows to match shape files
rownames(cptu5.province2) <- poly.province$admin_1
rownames(cptu5.district2) <- poly.district$DISTCODE

# combine data frame with the shape file
polydata.cptu5.province2 <- SpatialPolygonsDataFrame(poly.province, cptu5.province2, match.ID = F)
polydata.cptu5.district2 <- SpatialPolygonsDataFrame(poly.district, cptu5.district2, match.ID = F)

# plot avg. cptu5 for each province aggregated over annual quarters
spplot(polydata.cptu5.province2, c('cptu5.Quarter1', 'cptu5.Quarter2',
                                   'cptu5.Quarter3','cptu5.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Malaria Cases per 1000 Under 5",
       as.table = TRUE, col="transparent")
```


Across quarters and across provinces, it appears that the Niassa and the Cabo Delgado provinces seem to have the highest average malaria incidence in CPT-U5. Also, malaria incidence seemed to be increased in annual quarters 1 and 2. This is consistent with the previous bar graph visualizations that indicated the northern region had higher malaria incidence compared to the southern, central, and coastal regions and that quarters 1 and 2 had higher malaria incidence. 


The higher proportion of CPT-U5 in the northern region overlaps with the patterns we see for total rainfall and temperature. Generally speaking, the provinces with increased malaria incidence tended to have higher rainfall and temperature. The particular provinces I am refering to are the Niassa, Nampula, and Cabo Delgado provinces. However, this wasn't necessarily across the whole year. While the northern region/provinces seemed to have the highest average temperature over the whole year, it was discovered that rainfall was not consistently high or low for all provinces throughout the year. Thus, it can be concluded that the northern region may have more extreme, but annually inconsistent, climatic patterns, which likely provide the optimal enviroment for the malaria parasite to grow and be transmitted.  


Another interesting detail regarding malaria incidence was discovered. In the appendix of this report is a map plot that shows quarterly malaria incidence in CPT-U5 across *districts*. The map indicates that there is one district that seems to have an unusually high CPT-U5 malaria incidence. This district is the Meluco district in the Cabo Delgado province (average CPT-U5 is approximately 40). Another district that seems to have a high CPT-U5 malaria incidence is the Nipepe district in the Niassa province. Both of these provinces are in the northern region of Mozambique.  


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=8, dpi=125}
data.red <- data %>%
  select(Epiyear, Epiweek, rainTot, tavg, cptu5,
         Province, District, DISTCODE, Region) %>%
  mutate(hypoth.date = as.Date(paste(Epiyear, Epiweek, "1",
                                     sep = "-"), format="%Y-%U-%u")) %>%
  mutate(mean.cptu5 = mean(cptu5)) %>%
  mutate(factor.Epiyear = as.factor(Epiyear))

ts.data.region <- data.red %>%
  group_by(Region, hypoth.date) %>%
  summarise(mean.cptu5 = mean(cptu5),
            mean.rainTot = mean(rainTot),
            mean.tavg = mean(tavg))

ggplot(data=ts.data.region, aes(x=hypoth.date, y=mean.cptu5)) +
  geom_line(aes(color=Region)) +
  labs(y="Cases per 1000 Under 5", x="Date",
       title="Regional Malaria Incidence Over Time") +
  scale_color_manual(values = c("purple1", "darkblue", "orange1", "deeppink1"))

```


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=8, dpi=125}
# province plot
ts.data.province <- data.red %>%
  group_by(Province, hypoth.date) %>%
  summarise(mean.cptu5 = mean(cptu5),
            mean.rainTot = mean(rainTot),
            mean.tavg = mean(tavg))

ggplot(data=ts.data.province, aes(x=hypoth.date, y=mean.cptu5)) +
  geom_line(aes(color=Province)) +
  labs(y="Cases per 1000 Under 5", x="Date",
       title="Provincial Malaria Incidence Over Time") +
  scale_color_manual(values = c("purple4", "purple1", "darkblue", "blue",
                                "deepskyblue3", "cyan2", "yellow1",
                                "orange1", "deeppink1", "deeppink4"))

```


```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=8}
g5 <- ggplot(data=data.red, aes(x=Epiweek, y=cptu5, group=factor.Epiyear)) +
  geom_smooth(aes(color=factor.Epiyear), se=FALSE) +
  labs(y="Cases per 1000 Under 5",
       title="Seasonal Plot: CPT-U5") +
  scale_color_discrete(name = "Epiyear") +
  scale_color_manual(values = c("purple4", "purple1", "darkblue",
                               "deepskyblue3", "yellow1", "orange1",
                               "deeppink1"), name="Epiyear")

g6 <- ggplot(data=data.red, aes(x=Epiweek, y=rainTot, group=factor.Epiyear)) +
  geom_smooth(aes(color=factor.Epiyear), se=FALSE) +
  labs(y="Weekly Total Rainfall",
       title="Rainfall") +
  scale_color_discrete(name = "Epiyear") +
  scale_color_manual(values = c("purple4", "purple1", "darkblue",
                               "deepskyblue3", "yellow1", "orange1",
                               "deeppink1")) +
  theme(legend.position="none")

g7 <- ggplot(data=data.red, aes(x=Epiweek, y=tavg, group=factor.Epiyear)) +
  geom_smooth(aes(color=factor.Epiyear), se=FALSE) +
  labs(y="Average Temperature",
       title="Temperature") +
  scale_color_discrete(name = "Epiyear") +
  scale_color_manual(values = c("purple4", "purple1", "darkblue",
                               "deepskyblue3", "yellow1", "orange1",
                               "deeppink1")) +
  theme(legend.position="none")

grid.arrange(g5, g6, g7, nrow=1)

```


###Appendix
####*Histograms Showing Distibution of CPT-U5 and Transformed CPT-U5*
```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.height=3, fig.width=8}
# distribution of the outcome
ag1 <- ggplot(data=data) +
  geom_histogram(alpha=0.6, fill='purple', aes(x=cptu5)) +
  labs(x='CPT-U5', y='Frequency')
                                              # seems positively skewed
ag2 <- ggplot(data=data) +
  geom_histogram(alpha=0.6, fill='darkblue', aes(x=log(cptu5))) +
  labs(x='log(CPT-U5)', y='Frequency')
                                          # skewed negatively
ag3 <- ggplot(data=data) +
  geom_histogram(alpha=0.6, fill='deeppink2', aes(x=sqrt(cptu5))) +
  labs(x=expression(sqrt('CPT-U5')), y='Frequency')
                                                    # seems normally distributed
grid.arrange(ag1, ag2, ag3, nrow=1)

# If I were to model the data, I would likely square-root transform the outcome

```


####*Spatial Maps of Quarterly Rainfall, Temperature, and CPT-U5 Across Districts*
```{r, warning=FALSE, message=FALSE, echo=FALSE}
#plot avg. total rainfall for each district aggregated over annual quarters
spplot(polydata.district2, c('rain.Quarter1', 'rain.Quarter2',
                             'rain.Quarter3','rain.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Average Total Weekly Rainfall (mm)",
       as.table = TRUE,  col="transparent")

#plot avg. total rainfall for each district aggregated over annual quarters
spplot(polydata.district2, c('tavg.Quarter1', 'tavg.Quarter2',
                             'tavg.Quarter3','tavg.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Average Temperature (Celcius)",
       as.table = TRUE,  col="transparent")

#plot avg. cptu5 for each district aggregated over annual quarters
spplot(polydata.cptu5.district2, c('cptu5.Quarter1', 'cptu5.Quarter2',
                                   'cptu5.Quarter3','cptu5.Quarter4'),
       names.attr = c('Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'),
       colorkey=list(space="right"), scales = list(draw = TRUE),
       main = "Malaria Cases per 1000 Under 5",
       as.table = TRUE, col="transparent")

```



